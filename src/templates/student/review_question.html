{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto space-y-6">

  <!-- Score banner -->
  <section class="flex flex-wrap items-center gap-4 rounded-lg border border-gray-200 bg-gray-50 p-4 shadow-sm">
    <div><strong>Score:</strong> {{ totals.correct }}/{{ totals.total }}</div>
    <div>Correct: <strong class="text-green-700">{{ totals.correct }}</strong></div>
    <div>Incorrect: <strong class="text-red-700">{{ totals.incorrect }}</strong></div>
    <div>Unanswered: <strong class="text-amber-700">{{ totals.unanswered }}</strong></div>
    <div class="ml-auto">
      <a href="{{ url_for('student.summary', test_id=test.id) }}"
         class="px-4 py-2 rounded-lg border border-academic-navy text-academic-navy text-sm hover:bg-academic-navy hover:text-white transition">
        Summary
      </a>
    </div>
  </section>

  <!-- Header -->
  <header class="flex justify-between items-center">
    <div>
      <h2 class="text-lg font-semibold text-academic-navy border-b-4 border-academic-navy pb-1">
        Review — Question {{ n }} of {{ test.total_questions }}
      </h2>
      <p class="text-sm text-gray-600">
        Mode: {{ test.mode.value|capitalize }}
        {% if test.mode.value == 'interactive' and test.test_uid %}
          • Share ID: <code class="bg-gray-100 px-1.5 py-0.5 rounded">{{ test.test_uid }}</code>
        {% endif %}
      </p>
    </div>
  </header>

  <!-- Question -->
  <article>
    <div class="rounded-lg border-2 border-dashed border-gray-300 bg-white p-4">
      <p class="text-gray-800">{{ q.question_text | safe }}</p>
    </div>

    {% if q.question_image %}
      <div class="mt-3">
        <img src="{{ url_for('uploads.serve_upload', relpath=q.question_image) }}" alt="Question image"
             class="max-w-full h-auto rounded-lg border border-gray-200 shadow-sm">
      </div>
    {% endif %}

    <!-- Options -->
    <div class="mt-6 space-y-3">
      {% set selected = resp.selected_option if resp else None %}
      {% for code, text, img in [
        ('A', q.option_a, q.option_a_image),
        ('B', q.option_b, q.option_b_image),
        ('C', q.option_c, q.option_c_image),
        ('D', q.option_d, q.option_d_image),
      ] %}
        {% set css = '' %}
        {% set badge = '' %}
        {% if test.mode.value == 'display' %}
          {% if code == q.correct_option %}
            {% set css = 'border-green-600 bg-green-50 text-green-800' %}
            {% set badge = 'Correct' %}
          {% endif %}
        {% else %}
          {% if code == q.correct_option and selected == code %}
            {% set css = 'border-green-600 bg-green-50 text-green-800' %}
            {% set badge = 'Your answer ✓' %}
          {% elif code == selected and selected != q.correct_option %}
            {% set css = 'border-red-600 bg-red-50 text-red-800' %}
            {% set badge = 'Your answer ✗' %}
          {% elif code == q.correct_option %}
            {% set css = 'border-green-600 bg-green-50 text-green-800' %}
            {% set badge = 'Correct answer' %}
          {% endif %}
        {% endif %}

        <div class="flex items-start gap-3 border rounded-lg p-3 {{ css }}">
          <span class="font-semibold text-academic-navy w-6">{{ code }}</span>
          <span class="flex-1 text-gray-800">
            {{ text | safe }}
            {% if badge %}
              <span class="ml-2 font-semibold">{{ badge }}</span>
            {% endif %}
          </span>
        </div>

        {% if img %}
          <div class="ml-9">
            <img src="{{ url_for('uploads.serve_upload', relpath=img) }}" alt="Option {{ code }} image"
                 class="max-w-full h-auto rounded-lg border border-gray-200 shadow-sm">
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </article>

  <!-- Navigation -->
  <div class="sticky bottom-0 bg-white border-t border-gray-200 py-3 flex justify-between items-center">
    <div>
      {% if has_prev %}
        <a href="{{ prev_url }}"
           class="px-4 py-2 rounded-lg border border-academic-navy text-academic-navy text-sm hover:bg-academic-navy hover:text-white transition">
          &larr; Previous
        </a>
      {% endif %}
    </div>
    <div>
      {% if has_next %}
        <a href="{{ next_url }}"
           class="px-4 py-2 rounded-lg bg-academic-navy text-white text-sm hover:bg-academic-maroon transition">
          Next &rarr;
        </a>
      {% else %}
        <a href="{{ url_for('student.summary', test_id=test.id) }}"
           class="px-4 py-2 rounded-lg bg-academic-maroon text-white text-sm hover:bg-academic-navy transition">
          Back to Summary
        </a>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
