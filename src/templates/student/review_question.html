{% extends "base.html" %}
{% block content %}
<div class="page">
  {# Score banner on top #}
  <section class="banner" style="margin-top:.5rem;">
    <div><strong>Score:</strong> {{ totals.correct }}/{{ totals.total }}</div>
    <div>Correct: <strong style="color:var(--ok);">{{ totals.correct }}</strong></div>
    <div>Incorrect: <strong style="color:var(--bad);">{{ totals.incorrect }}</strong></div>
    <div>Unanswered: <strong style="color:var(--warn);">{{ totals.unanswered }}</strong></div>
    <div style="margin-left:auto;">
      <a class="btn btn-outline" href="{{ url_for('student.summary', test_id=test.id) }}">Summary</a>
    </div>
  </section>

  <header style="display:flex;justify-content:space-between;align-items:center;gap:.75rem; margin-top:1rem;">
    <div>
      <h2 class="h-academic">Review — Question {{ n }} of {{ test.total_questions }}</h2>
      <div class="qmeta">
        Mode: {{ test.mode.value | capitalize }}
        {% if test.mode.value == 'interactive' and test.test_uid %}
          • Share ID: <code>{{ test.test_uid }}</code>
        {% endif %}
      </div>
    </div>
  </header>

  <article style="margin-top:1rem;">
    <div class="option" style="border-style:dashed; background:#fffefb;">
      <span class="opt-text">{{ q.question_text | safe }}</span>
    </div>

    {% if q.question_image %}
      <div class="imgs">
        <img src="{{ url_for('uploads', relpath=q.question_image) }}" alt="Question image">
      </div>
    {% endif %}

    <div class="options">
      {% set selected = resp.selected_option if resp else None %}
      {% for code, text, img in [
        ('A', q.option_a, q.option_a_image),
        ('B', q.option_b, q.option_b_image),
        ('C', q.option_c, q.option_c_image),
        ('D', q.option_d, q.option_d_image),
      ] %}
        {% set css = '' %}
        {% set badge = '' %}
        {% if test.mode.value == 'display' %}
          {% if code == q.correct_option %}
            {% set css = 'is-correct' %}
            {% set badge = '<span style="margin-left:.5rem; color:var(--ok); font-weight:600;">Correct</span>' %}
          {% endif %}
        {% else %}
          {% if code == q.correct_option and selected == code %}
            {% set css = 'is-correct' %}
            {% set badge = '<span style="margin-left:.5rem; color:var(--ok); font-weight:600;">Your answer ✓</span>' %}
          {% elif code == selected and selected != q.correct_option %}
            {% set css = 'is-wrong' %}
            {% set badge = '<span style="margin-left:.5rem; color:var(--bad); font-weight:600;">Your answer ✗</span>' %}
          {% elif code == q.correct_option %}
            {% set css = 'is-correct' %}
            {% set badge = '<span style="margin-left:.5rem; color:var(--ok); font-weight:600;">Correct answer</span>' %}
          {% endif %}
        {% endif %}

        <div class="option {{ css }}">
          <span class="opt-label">{{ code }}</span>
          <span class="opt-text">{{ text | safe }} {{ badge | safe }}</span>
        </div>
        {% if img %}
          <div class="imgs" style="margin-left:3rem;">
            <img src="{{ url_for('uploads', relpath=img) }}" alt="Option {{ code }} image">
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </article>

  <div class="sticky-nav" style="margin-top:1rem;">
    <div>
      {% if has_prev %}
        <a class="btn btn-outline" href="{{ prev_url }}">&larr; Previous</a>
      {% endif %}
    </div>
    <div>
      {% if has_next %}
        <a class="btn btn-primary" href="{{ next_url }}">Next &rarr;</a>
      {% else %}
        <a class="btn btn-accent" href="{{ url_for('student.summary', test_id=test.id) }}">Back to Summary</a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
