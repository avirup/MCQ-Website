{% extends "base.html" %}
{% block content %}
  <h1>Start Test</h1>

  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      <ul>
        {% for category, msg in msgs %}
          <li><strong>{{ category|capitalize }}:</strong> {{ msg }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <form method="post" action="{{ url_for('student.start_test') }}">
    {{ form.csrf_token }}

    <div>
      <label for="subject_id">{{ form.subject_id.label }}</label><br>
      {{ form.subject_id(id="subject_id") }}
      <div id="available-note" class="qmeta" style="margin-top:.35rem;"></div>
      {% for e in form.subject_id.errors %}<div style="color:#b00;">{{ e }}</div>{% endfor %}
    </div>


    <div style="margin-top:0.5rem;">
      <label>{{ form.mode.label }}</label><br>
      {{ form.mode() }}
    </div>

    <div style="margin-top:0.5rem;">
      <label>{{ form.difficulty_filter.label }}</label><br>
      {{ form.difficulty_filter() }}
    </div>

    <div style="margin-top:0.5rem;">
      <label>{{ form.number_of_questions.label }}</label><br>
      {{ form.number_of_questions(min=1) }}
      {% for e in form.number_of_questions.errors %}<div style="color:#b00;">{{ e }}</div>{% endfor %}
    </div>

    <div style="margin-top:0.5rem;">
      <label>{{ form.timer_mode.label }}</label><br>
      {{ form.timer_mode() }}
    </div>

    <div style="margin-top:0.5rem;">
      <label>{{ form.per_question_duration.label }}</label><br>
      {{ form.per_question_duration(min=5) }}
      <small>Used when Timer Mode is "Per Question".</small>
      {% for e in form.per_question_duration.errors %}<div style="color:#b00;">{{ e }}</div>{% endfor %}
    </div>

    <div style="margin-top:0.5rem;">
      <label>{{ form.total_test_duration.label }}</label><br>
      {{ form.total_test_duration(min=30) }}
      <small>Used when Timer Mode is "Total Test".</small>
      {% for e in form.total_test_duration.errors %}<div style="color:#b00;">{{ e }}</div>{% endfor %}
    </div>

    <div style="margin-top:0.5rem;">
      <label>{{ form.auto_advance.label }}</label>
      {{ form.auto_advance() }}
      <small>Works with per-question timer.</small>
    </div>

    <div style="margin-top:1rem;">
      {{ form.submit() }}
    </div>
  </form>

  <script>
  // subject_id -> total questions (provided by the route)
    const AVAILABLE_MAP = {{ available_map | tojson }};

    const subjSel  = document.getElementById('subject_id');
    const noteEl   = document.getElementById('available-note');
    const numInput = document.getElementById('number_of_questions'); // optional

    function updateAvailable() {
      const sid = String(subjSel.value || "");
      const count = AVAILABLE_MAP[sid] ?? 0;

     if (noteEl) {
       const s = count === 1 ? "" : "s";
        noteEl.textContent = `Available: ${count} question${s} in this subject`;
      }

    // Optional UX: hint and max on number field
      if (numInput) {
        numInput.max = Math.max(count, 1);
        if (!numInput.value) {
          numInput.placeholder = count > 0 ? `Max ${count}` : "No questions available";
        }
      }
    }

    document.addEventListener('DOMContentLoaded', updateAvailable);
    subjSel.addEventListener('change', updateAvailable);
  </script>


{% endblock %}
