{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto">

  <!-- Header -->
  <header class="flex justify-between items-end mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-academic-navy border-b-4 border-academic-navy pb-1">
        Start a New Test
      </h1>
      <p class="text-sm text-gray-600">Pick a subject and configure options.</p>
    </div>
    <a href="{{ url_for('student.home') }}"
       class="px-4 py-2 rounded-lg border border-academic-navy text-academic-navy hover:bg-academic-navy hover:text-white transition text-sm">
      Reset
    </a>
  </header>

  <!-- Flash messages -->
  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-lg p-3 mb-6 text-sm">
        <ul class="list-disc list-inside space-y-1">
          {% for category, msg in msgs %}
            <li><strong>{{ category|capitalize }}:</strong> {{ msg }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  {% endwith %}

  <!-- Form -->
  <form method="post" action="{{ url_for('student.start_test') }}" class="space-y-6">
    {{ form.csrf_token }}

    <section class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- Subject -->
      <div>
        <label for="subject_id" class="block text-sm font-medium text-gray-700">
          {{ form.subject_id.label.text }}
        </label>
        {{ form.subject_id(id="subject_id", class_="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-academic-navy focus:border-academic-navy") }}
        <div id="available-note" class="text-xs text-gray-500 mt-1"></div>
        {% for e in form.subject_id.errors %}<p class="text-red-600 text-sm">{{ e }}</p>{% endfor %}
      </div>

      <!-- Mode -->
      <div>
        <label for="mode" class="block text-sm font-medium text-gray-700">
          {{ form.mode.label.text }}
        </label>
        {{ form.mode(id="mode", class_="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-academic-navy focus:border-academic-navy") }}
        {% for e in form.mode.errors %}<p class="text-red-600 text-sm">{{ e }}</p>{% endfor %}
      </div>

      <!-- Difficulty -->
      <div>
        <label for="difficulty_filter" class="block text-sm font-medium text-gray-700">
          {{ form.difficulty_filter.label.text }}
        </label>
        {{ form.difficulty_filter(id="difficulty_filter", class_="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-academic-navy focus:border-academic-navy") }}
        {% for e in form.difficulty_filter.errors %}<p class="text-red-600 text-sm">{{ e }}</p>{% endfor %}
      </div>

      <!-- Number of questions -->
      <div>
        <label for="number_of_questions" class="block text-sm font-medium text-gray-700">
          {{ form.number_of_questions.label.text }}
        </label>
        {{ form.number_of_questions(id="number_of_questions", class_="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-academic-navy focus:border-academic-navy", min=1) }}
        {% for e in form.number_of_questions.errors %}<p class="text-red-600 text-sm">{{ e }}</p>{% endfor %}
      </div>

      <!-- Timer mode -->
      <div>
        <label for="timer_mode" class="block text-sm font-medium text-gray-700">
          {{ form.timer_mode.label.text }}
        </label>
        {{ form.timer_mode(id="timer_mode", class_="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-academic-navy focus:border-academic-navy") }}
        {% for e in form.timer_mode.errors %}<p class="text-red-600 text-sm">{{ e }}</p>{% endfor %}
      </div>

      <!-- Per-question duration -->
      <div id="perq_wrap">
        <label for="per_question_duration" class="block text-sm font-medium text-gray-700">
          {{ form.per_question_duration.label.text }}
        </label>
        {{ form.per_question_duration(id="per_question_duration", class_="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-academic-navy focus:border-academic-navy", min=5) }}
        <p class="text-xs text-gray-500 mt-1">Used when Timer Mode is “Per Question”.</p>
        {% for e in form.per_question_duration.errors %}<p class="text-red-600 text-sm">{{ e }}</p>{% endfor %}
      </div>

      <!-- Total test duration -->
      <div id="tot_wrap" style="display:none;">
        <label for="total_test_duration" class="block text-sm font-medium text-gray-700">
          {{ form.total_test_duration.label.text }}
        </label>
        {{ form.total_test_duration(id="total_test_duration", class_="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-academic-navy focus:border-academic-navy", min=30) }}
        <p class="text-xs text-gray-500 mt-1">Used when Timer Mode is “Total Test”.</p>
        {% for e in form.total_test_duration.errors %}<p class="text-red-600 text-sm">{{ e }}</p>{% endfor %}
      </div>

      <!-- Auto advance -->
      <div id="auto_wrap">
        <label for="auto_advance" class="block text-sm font-medium text-gray-700">
          {{ form.auto_advance.label.text }}
        </label>
        <div class="flex items-center gap-2 mt-1">
          {{ form.auto_advance(id="auto_advance") }}
          <span class="text-xs text-gray-500">If per-question timer is on, moves automatically.</span>
        </div>
        {% for e in form.auto_advance.errors %}<p class="text-red-600 text-sm">{{ e }}</p>{% endfor %}
      </div>
    </section>

    <!-- Actions -->
    <div class="flex items-center justify-between border-t border-gray-200 pt-4">
      <p class="text-xs text-gray-500">Ready? Double-check your choices.</p>
      <div>
        {{ form.submit(class_="px-4 py-2 rounded-lg bg-academic-navy text-white hover:bg-academic-maroon transition") }}
      </div>
    </div>
  </form>
</div>

<!-- JS: available count & timer mode toggling -->
{% if available_map is defined %}
<script>
  const AVAILABLE_MAP = {{ available_map | tojson }};
  const subjSel  = document.getElementById('subject_id');
  const noteEl   = document.getElementById('available-note');
  const numInput = document.getElementById('number_of_questions');

  function updateAvailable() {
    const sid = String(subjSel.value || "");
    const count = AVAILABLE_MAP[sid] ?? 0;
    if (noteEl) noteEl.textContent = `Available: ${count} question${count===1?'':'s'} in this subject`;
    if (numInput) {
      numInput.max = Math.max(count, 1);
      if (!numInput.value) numInput.placeholder = count > 0 ? `Max ${count}` : "No questions available";
    }
  }
  document.addEventListener('DOMContentLoaded', updateAvailable);
  subjSel?.addEventListener('change', updateAvailable);
</script>
{% endif %}

<script>
  (function () {
    const sel = document.getElementById('timer_mode');
    const perq = document.getElementById('perq_wrap');
    const tot  = document.getElementById('tot_wrap');
    const auto = document.getElementById('auto_wrap');

    function toggle() {
      const v = sel.value;
      if (v === 'per-question') {
        perq.style.display = '';
        auto.style.display = '';
        tot.style.display = 'none';
      } else {
        perq.style.display = 'none';
        auto.style.display = 'none';
        tot.style.display = '';
      }
    }

    document.addEventListener('DOMContentLoaded', toggle);
    sel?.addEventListener('change', toggle);
  })();
</script>
{% endblock %}
