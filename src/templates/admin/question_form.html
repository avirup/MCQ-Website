{% extends "admin/base_admin.html" %}
{% block admin_content %}

<h2 class="text-lg font-semibold text-academic-navy border-b-4 border-academic-navy pb-1">
  {{ 'Edit Question' if edit_mode else 'New Question' }}
</h2>

<form method="post" enctype="multipart/form-data" class="space-y-6 mt-4">
  {{ form.csrf_token }}

  <!-- Core fields -->
  <section class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 space-y-4">
    <div>
      <label for="{{ form.subject_id.id }}" class="block text-sm font-medium text-gray-700">
        {{ form.subject_id.label.text }}
      </label>
      {{ form.subject_id(class_="w-full rounded-lg border border-gray-300 px-3 py-2 mt-1 text-sm focus:ring-academic-navy focus:border-academic-navy") }}
      {% for e in form.subject_id.errors %}
        <p class="text-red-600 text-sm mt-1">{{ e }}</p>
      {% endfor %}
    </div>

    <div>
      <label for="{{ form.question_text.id }}" class="block text-sm font-medium text-gray-700">
        {{ form.question_text.label.text }}
      </label>
      <p class="text-xs text-gray-500 mt-1">Enter text OR upload an image (at least one required). Supports LaTeX.</p>
      {{ form.question_text(class_="w-full rounded-lg border border-gray-300 px-3 py-2 mt-1 text-sm min-h-[140px] focus:ring-academic-navy focus:border-academic-navy") }}
      {% for e in form.question_text.errors %}
        <p class="text-red-600 text-sm mt-1">{{ e }}</p>
      {% endfor %}
    </div>

    <div>
      <label for="{{ form.question_image.id }}" class="block text-sm font-medium text-gray-700">
        {{ form.question_image.label.text }}
      </label>
      {{ form.question_image(class_="mt-1 block text-sm") }}
      {% if edit_mode and q.question_image %}
        <p class="text-xs text-gray-500 mt-2">
          Current: <a href="{{ url_for('uploads.serve_upload', relpath=q.question_image) }}" target="_blank" class="text-academic-navy underline">view image</a>
        </p>
      {% endif %}
      {% for e in form.question_image.errors %}
        <p class="text-red-600 text-sm mt-1">{{ e }}</p>
      {% endfor %}
    </div>
  </section>

  <!-- Options -->
  <section class="bg-white border border-gray-200 rounded-xl shadow-sm p-4">
    <h3 class="text-md font-semibold text-academic-navy border-b border-gray-200 pb-1 mb-3">Options</h3>
    <div class="grid grid-cols-1 gap-4">

      {% for code, text_field, img_field, img_attr in [
        ('A', form.option_a, form.option_a_image, q.option_a_image if edit_mode else None),
        ('B', form.option_b, form.option_b_image, q.option_b_image if edit_mode else None),
        ('C', form.option_c, form.option_c_image, q.option_c_image if edit_mode else None),
        ('D', form.option_d, form.option_d_image, q.option_d_image if edit_mode else None),
      ] %}
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 space-y-3">
        <label for="{{ text_field.id }}" class="block text-sm font-medium text-gray-700">Option {{ code }}</label>
        <p class="text-xs text-gray-500">Enter text OR upload an image (at least one required).</p>
        {{ text_field(class_="w-full rounded-lg border border-gray-300 px-3 py-2 mt-1 text-sm min-h-[90px] focus:ring-academic-navy focus:border-academic-navy") }}
        {% for e in text_field.errors %}
          <p class="text-red-600 text-sm mt-1">{{ e }}</p>
        {% endfor %}
        
        {{ img_field(class_="mt-2 block text-sm") }}
        {% if edit_mode and img_attr %}
          <p class="text-xs text-gray-500 mt-2">
            Current: <a href="{{ url_for('uploads.serve_upload', relpath=img_attr) }}" target="_blank" class="text-academic-navy underline">view image</a>
          </p>
        {% endif %}
        {% for e in img_field.errors %}
          <p class="text-red-600 text-sm mt-1">{{ e }}</p>
        {% endfor %}
      </div>
      {% endfor %}

    </div>
  </section>

  <!-- Correct Option + Difficulty -->
  <section class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 grid grid-cols-1 gap-4">
    <div>
      <label for="{{ form.correct_option.id }}" class="block text-sm font-medium text-gray-700">
        {{ form.correct_option.label.text }}
      </label>
      {{ form.correct_option(class_="w-full rounded-lg border border-gray-300 px-3 py-2 mt-1 text-sm focus:ring-academic-navy focus:border-academic-navy") }}
      {% for e in form.correct_option.errors %}
        <p class="text-red-600 text-sm mt-1">{{ e }}</p>
      {% endfor %}
    </div>
    {% if form.difficulty is defined %}
    <div>
      <label for="{{ form.difficulty.id }}" class="block text-sm font-medium text-gray-700">
        {{ form.difficulty.label.text }}
      </label>
      {{ form.difficulty(class_="w-full rounded-lg border border-gray-300 px-3 py-2 mt-1 text-sm focus:ring-academic-navy focus:border-academic-navy") }}
      {% for e in form.difficulty.errors %}
        <p class="text-red-600 text-sm mt-1">{{ e }}</p>
      {% endfor %}
    </div>
    {% endif %}
  </section>

  <!-- Actions -->
  <div class="sticky bottom-0 bg-white border-t border-gray-200 py-3 flex justify-between items-center">
    <p class="text-sm text-gray-500">Review your entries before saving.</p>
    <div class="flex gap-2">
      {{ form.submit(class_="px-4 py-2 rounded-lg bg-academic-navy text-white hover:bg-academic-maroon transition") }}
      <a href="{{ url_for('admin.questions') }}"
         class="px-4 py-2 rounded-lg border border-academic-navy text-academic-navy hover:bg-academic-navy hover:text-white transition">
        Cancel
      </a>
    </div>
  </div>
</form>

{% endblock %}
